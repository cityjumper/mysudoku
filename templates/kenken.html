{% extends "base.html" %}

{% block title %}KenKen{% endblock %}

{% block extra_head %}
    <style>
        .cell {
            width: 80px;
            height: 80px;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #6b7280;
            background: white;
            position: relative;
        }
        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            background: transparent;
        }
        .cell-input:focus {
            outline: none;
            background: #f3f4f6;
        }
        .cage-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            font-weight: bold;
            color: #dc2626;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 2px;
            border-radius: 2px;
        }
        .cage-border-top {
            border-top: 3px solid #374151 !important;
        }
        .cage-border-left {
            border-left: 3px solid #374151 !important;
        }
        .cage-border-right {
            border-right: 3px solid #374151 !important;
        }
        .cage-border-bottom {
            border-bottom: 3px solid #374151 !important;
        }
        .cage-highlight {
            background: rgba(251, 146, 60, 0.1) !important;
        }
        @media (min-width: 640px) {
            .cell {
                width: 96px;
                height: 96px;
                font-size: 28px;
            }
            .cell-input {
                font-size: 28px;
            }
        }
    </style>
{% endblock %}

{% block body_class %}bg-gradient-to-br from-slate-50 to-orange-100 min-h-screen{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- Top Nav -->
        <div class="max-w-6xl mx-auto mb-6 flex items-center justify-between">
            <a href="/" class="inline-flex items-center text-orange-800 hover:text-orange-950 font-semibold">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M12.707 15.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 111.414 1.414L7.414 9H17a1 1 0 110 2H7.414l5.293 5.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Home
            </a>
            <a href="/sudoku" class="text-sm font-semibold text-indigo-700 hover:text-indigo-900">Sudoku</a>
        </div>

        <div class="max-w-6xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-slate-900">KenKen</h1>
                <p class="mt-2 text-slate-600">Mathematical logic puzzles with arithmetic operations.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Board -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-2xl shadow-xl ring-1 ring-slate-200 p-6 sm:p-8">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                            <div>
                                <div class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Status</div>
                                <div id="status" class="mt-1 text-2xl font-bold text-slate-900">Fill the grid</div>
                                <div id="substatus" class="mt-1 text-slate-600">Use numbers 1-4, each once per row/column.</div>
                            </div>
                            <div class="flex gap-2">
                                <button id="new-game" class="rounded-lg bg-orange-600 hover:bg-orange-700 text-white font-semibold px-4 py-2">New Game</button>
                                <button id="check-solution" class="rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2">Check</button>
                                <button id="show-hint" class="rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-800 font-semibold px-4 py-2">Hint</button>
                                <button id="show-solution" class="rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2">Solution</button>
                            </div>
                        </div>

                        <div class="inline-block bg-white" id="board">
                            <!-- Board will be generated by JavaScript -->
                        </div>

                        <div class="mt-6 text-sm text-slate-500">
                            <p>Fill each row and column with numbers 1-4. Each cage must satisfy its arithmetic operation.</p>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-xl ring-1 ring-slate-200 p-6 sticky top-8">
                        <h2 class="text-xl font-bold text-slate-900 mb-4">Cages</h2>
                        <div id="cages-list" class="space-y-2 text-sm">
                            <!-- Cages will be listed here -->
                        </div>

                        <div class="mt-6">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">Rules</h3>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• Fill grid with 1-4, no repeats in rows/columns</li>
                                <li>• Each cage has a target number and operation</li>
                                <li>• Operations: + (sum), × (product), − (difference), ÷ (quotient)</li>
                                <li>• Single cells have no operation, just the number</li>
                            </ul>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">Controls</h3>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>• Click cells to input numbers</li>
                                <li>• Use number keys 1-4</li>
                                <li>• Backspace/Delete to clear</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Multiple KenKen puzzles for random selection
        const PUZZLES = [
            {
                size: 4,
                cages: [
                    { cells: [[0,0], [0,1]], operation: '+', target: 3 },
                    { cells: [[0,2], [0,3], [1,3]], operation: '+', target: 8 },
                    { cells: [[1,0], [2,0]], operation: '+', target: 5 },
                    { cells: [[1,1], [1,2]], operation: '×', target: 6 },
                    { cells: [[2,1], [3,1]], operation: '+', target: 3 },
                    { cells: [[2,2], [2,3], [3,2], [3,3]], operation: '×', target: 24 },
                    { cells: [[3,0]], operation: '', target: 2 }
                ],
                solution: [
                    [1, 2, 4, 3],
                    [4, 3, 1, 2],
                    [2, 1, 3, 4],
                    [3, 4, 2, 1]
                ]
            },
            {
                size: 4,
                cages: [
                    { cells: [[0,0], [1,0]], operation: '+', target: 5 },
                    { cells: [[0,1], [0,2]], operation: '×', target: 8 },
                    { cells: [[0,3], [1,3]], operation: '+', target: 3 },
                    { cells: [[1,1], [2,1]], operation: '+', target: 4 },
                    { cells: [[1,2], [2,2], [2,3]], operation: '+', target: 9 },
                    { cells: [[2,0], [3,0], [3,1]], operation: '×', target: 6 },
                    { cells: [[3,2], [3,3]], operation: '×', target: 12 }
                ],
                solution: [
                    [2, 4, 2, 1],
                    [3, 1, 4, 2],
                    [1, 3, 1, 3],
                    [4, 2, 3, 4]
                ]
            },
            {
                size: 4,
                cages: [
                    { cells: [[0,0], [0,1], [1,0]], operation: '+', target: 6 },
                    { cells: [[0,2], [1,2]], operation: '+', target: 4 },
                    { cells: [[0,3], [1,3], [2,3]], operation: '+', target: 7 },
                    { cells: [[1,1], [2,1]], operation: '×', target: 3 },
                    { cells: [[2,0], [3,0]], operation: '+', target: 5 },
                    { cells: [[2,2], [3,2]], operation: '×', target: 8 },
                    { cells: [[3,1], [3,3]], operation: '+', target: 4 }
                ],
                solution: [
                    [1, 2, 1, 3],
                    [3, 1, 3, 2],
                    [2, 3, 4, 1],
                    [4, 4, 2, 1]
                ]
            },
            {
                size: 4,
                cages: [
                    { cells: [[0,0], [1,0]], operation: '×', target: 4 },
                    { cells: [[0,1], [0,2]], operation: '+', target: 5 },
                    { cells: [[0,3], [1,3]], operation: '+', target: 4 },
                    { cells: [[1,1], [2,1], [1,2]], operation: '+', target: 8 },
                    { cells: [[2,0], [3,0]], operation: '+', target: 3 },
                    { cells: [[2,2], [2,3], [3,2], [3,3]], operation: '×', target: 24 },
                    { cells: [[3,1]], operation: '', target: 1 }
                ],
                solution: [
                    [2, 1, 4, 3],
                    [2, 3, 1, 1],
                    [1, 4, 2, 3],
                    [2, 1, 4, 3]
                ]
            }
        ];

        let currentPuzzleIndex = 0;
        let PUZZLE = PUZZLES[currentPuzzleIndex];
        let board = Array(4).fill().map(() => Array(4).fill(''));
        let selectedCell = null;

        const statusEl = document.getElementById('status');
        const substatusEl = document.getElementById('substatus');
        const boardEl = document.getElementById('board');
        const cagesListEl = document.getElementById('cages-list');

        function createBoard() {
            boardEl.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-4 gap-0 border-2 border-gray-900';

            // Create cage color mapping for visual distinction
            const cageColors = ['bg-orange-50', 'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-pink-50', 'bg-indigo-50', 'bg-yellow-50'];
            const cageColorMap = new Map();

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    // Find which cage this cell belongs to
                    const cageIndex = PUZZLE.cages.findIndex(c => c.cells.some(([r, c]) => r === row && c === col));
                    if (cageIndex !== -1) {
                        if (!cageColorMap.has(cageIndex)) {
                            cageColorMap.set(cageIndex, cageColors[cageColorMap.size % cageColors.length]);
                        }
                        cell.classList.add(cageColorMap.get(cageIndex));
                    }

                    // Add cage boundary borders
                    const cage = PUZZLE.cages.find(c => c.cells.some(([r, c]) => r === row && c === col));
                    if (cage) {
                        const isTopLeft = cage.cells[0][0] === row && cage.cells[0][1] === col;
                        const isTop = row === Math.min(...cage.cells.map(([r]) => r));
                        const isLeft = col === Math.min(...cage.cells.map(([,c]) => c));
                        const isBottom = row === Math.max(...cage.cells.map(([r]) => r));
                        const isRight = col === Math.max(...cage.cells.map(([,c]) => c));

                        if (isTop) cell.classList.add('cage-border-top');
                        if (isLeft) cell.classList.add('cage-border-left');
                        if (isBottom) cell.classList.add('cage-border-bottom');
                        if (isRight) cell.classList.add('cage-border-right');

                        // Add cage label to top-left cell of each cage
                        if (isTopLeft) {
                            const label = document.createElement('div');
                            label.className = 'cage-label';
                            label.textContent = cage.target + (cage.operation || '');
                            cell.appendChild(label);
                        }
                    }

                    const input = document.createElement('input');
                    input.className = 'cell-input';
                    input.type = 'text';
                    input.maxLength = 1;
                    input.value = board[row][col];
                    input.addEventListener('focus', () => selectCell(cell));
                    input.addEventListener('input', (e) => handleInput(e, row, col));
                    input.addEventListener('keydown', handleKeydown);

                    cell.appendChild(input);
                    grid.appendChild(cell);
                }
            }

            boardEl.appendChild(grid);
        }

        function selectCell(cell) {
            if (selectedCell) {
                selectedCell.classList.remove('ring-2', 'ring-blue-500');
            }
            selectedCell = cell;
            cell.classList.add('ring-2', 'ring-blue-500');
        }

        function handleInput(e, row, col) {
            const value = e.target.value;
            if (value && !/^[1-4]$/.test(value)) {
                e.target.value = '';
                return;
            }
            board[row][col] = value;
            checkCompletion();
        }

        function handleKeydown(e) {
            if (e.key >= '1' && e.key <= '4') {
                e.target.value = e.key;
                const row = parseInt(e.target.parentElement.dataset.row);
                const col = parseInt(e.target.parentElement.dataset.col);
                board[row][col] = e.key;
                checkCompletion();
            } else if (e.key === 'Backspace' || e.key === 'Delete') {
                e.target.value = '';
                const row = parseInt(e.target.parentElement.dataset.row);
                const col = parseInt(e.target.parentElement.dataset.col);
                board[row][col] = '';
            }
        }

        function checkCompletion() {
            // Check rows and columns
            for (let i = 0; i < 4; i++) {
                const row = board[i].filter(x => x !== '');
                const col = board.map(r => r[i]).filter(x => x !== '');

                if (row.length === 4 && new Set(row).size !== 4) {
                    statusEl.textContent = 'Invalid - duplicate in row';
                    statusEl.className = 'mt-1 text-2xl font-bold text-red-600';
                    return;
                }
                if (col.length === 4 && new Set(col).size !== 4) {
                    statusEl.textContent = 'Invalid - duplicate in column';
                    statusEl.className = 'mt-1 text-2xl font-bold text-red-600';
                    return;
                }
            }

            // Check cages
            for (const cage of PUZZLE.cages) {
                if (!checkCage(cage)) {
                    statusEl.textContent = 'Invalid - cage rule broken';
                    statusEl.className = 'mt-1 text-2xl font-bold text-red-600';
                    return;
                }
            }

            // Check if complete
            const filled = board.flat().filter(x => x !== '').length;
            if (filled === 16) {
                statusEl.textContent = 'Congratulations!';
                statusEl.className = 'mt-1 text-2xl font-bold text-green-600';
                substatusEl.textContent = 'You solved the KenKen puzzle!';
            } else {
                statusEl.textContent = 'Valid so far';
                statusEl.className = 'mt-1 text-2xl font-bold text-blue-600';
            }
        }

        function checkCage(cage) {
            const values = cage.cells.map(([r, c]) => parseInt(board[r][c])).filter(x => !isNaN(x));
            if (values.length !== cage.cells.length) return true; // Not complete yet

            switch (cage.operation) {
                case '+':
                    return values.reduce((a, b) => a + b, 0) === cage.target;
                case '×':
                    return values.reduce((a, b) => a * b, 1) === cage.target;
                case '-':
                    return Math.abs(values[0] - values[1]) === cage.target;
                case '÷':
                    return values[0] / values[1] === cage.target || values[1] / values[0] === cage.target;
                default:
                    return values[0] === cage.target;
            }
        }

        function displayCages() {
            cagesListEl.innerHTML = '';
            PUZZLE.cages.forEach((cage, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-50 rounded text-xs';
                const operation = cage.operation ? ` ${cage.operation} ` : ' = ';
                div.textContent = `Cage ${index + 1}: ${cage.cells.length} cells${operation}${cage.target}`;
                cagesListEl.appendChild(div);
            });
        }

        function newGame() {
            // Select random puzzle
            const newIndex = Math.floor(Math.random() * PUZZLES.length);
            currentPuzzleIndex = newIndex;
            PUZZLE = PUZZLES[currentPuzzleIndex];

            // Reset board
            board = Array(4).fill().map(() => Array(4).fill(''));
            statusEl.textContent = 'Fill the grid';
            statusEl.className = 'mt-1 text-2xl font-bold text-slate-900';
            substatusEl.textContent = 'Use numbers 1-4, each once per row/column.';

            // Update display
            displayCages();
            createBoard();
        }

        function checkSolution() {
            checkCompletion();
        }

        function showHint() {
            // Simple hint: find an empty cell and suggest a valid number
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    if (board[row][col] === '') {
                        // Try numbers 1-4
                        for (let num = 1; num <= 4; num++) {
                            const testBoard = board.map(r => [...r]);
                            testBoard[row][col] = num.toString();
                            // Check if this number doesn't create duplicates
                            const rowValues = testBoard[row].filter(x => x !== '');
                            const colValues = testBoard.map(r => r[col]).filter(x => x !== '');
                            if (new Set(rowValues).size === rowValues.length &&
                                new Set(colValues).size === colValues.length) {
                                board[row][col] = num.toString();
                                createBoard();
                                statusEl.textContent = `Hint: Try ${num} at row ${row + 1}, column ${col + 1}`;
                                statusEl.className = 'mt-1 text-2xl font-bold text-blue-600';
                                return;
                            }
                        }
                    }
                }
            }
            statusEl.textContent = 'No hints available';
            statusEl.className = 'mt-1 text-2xl font-bold text-orange-600';
        }

        function showSolution() {
            // Fill the board with the solution
            const solution = PUZZLE.solution;
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    board[row][col] = solution[row][col].toString();
                }
            }
            createBoard();
            statusEl.textContent = 'Solution shown';
            statusEl.className = 'mt-1 text-2xl font-bold text-green-600';
            substatusEl.textContent = 'The puzzle has been completed for you.';
        }

        // Event listeners
        document.getElementById('new-game').addEventListener('click', newGame);
        document.getElementById('check-solution').addEventListener('click', checkSolution);
        document.getElementById('show-hint').addEventListener('click', showHint);
        document.getElementById('show-solution').addEventListener('click', showSolution);

        // Initialize
        displayCages();
        createBoard();
    </script>
{% endblock %}