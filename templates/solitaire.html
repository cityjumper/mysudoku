{% extends "base.html" %}

{% block title %}Solitaire{% endblock %}

{% block extra_head %}
    <style>
        .board {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 0 auto;
            background: #1f2937;
            border-radius: 8px;
            padding: 15px;
        }
        .hole {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #4b5563;
        }
        .hole:hover {
            background: #4b5563;
            transform: scale(1.05);
        }
        .hole.empty {
            background: #111827;
            border-color: #1f2937;
        }
        .hole.selected {
            background: #fbbf24;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5);
        }
        .marble {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 2px solid #d97706;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .hole.selected .marble {
            transform: scale(1.1);
        }
        .possible-move {
            background: #10b981;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.5);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @media (min-width: 640px) {
            .board {
                width: 420px;
                height: 420px;
            }
            .hole {
                width: 48px;
                height: 48px;
            }
            .marble {
                width: 36px;
                height: 36px;
            }
        }
    </style>
{% endblock %}

{% block body_class %}bg-gradient-to-br from-slate-50 to-amber-100 min-h-screen{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- Top Nav -->
        <div class="max-w-5xl mx-auto mb-6 flex items-center justify-between">
            <a href="/" class="inline-flex items-center text-amber-800 hover:text-amber-950 font-semibold">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M12.707 15.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 111.414 1.414L7.414 9H17a1 1 0 110 2H7.414l5.293 5.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Home
            </a>
            <a href="/sudoku" class="text-sm font-semibold text-indigo-700 hover:text-indigo-900">Sudoku</a>
        </div>

        <div class="max-w-5xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-slate-900">Peg Solitaire</h1>
                <p class="mt-2 text-slate-600">Jump over marbles to remove them. Center starts empty - try to leave one there!</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Board -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-xl ring-1 ring-slate-200 p-6 sm:p-8">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                            <div>
                                <div class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Status</div>
                                <div id="status" class="mt-1 text-2xl font-bold text-slate-900">Select a marble to move</div>
                                <div id="substatus" class="mt-1 text-slate-600">Click a marble, then click where to jump.</div>
                            </div>
                            <div class="flex gap-2">
                                <button id="new-game" class="rounded-lg bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2">New Game</button>
                                <button id="undo" class="rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-800 font-semibold px-4 py-2">Undo</button>
                            </div>
                        </div>

                        <div id="board" class="board">
                            <!-- Board will be generated by JavaScript -->
                        </div>

                        <div class="mt-6 text-sm text-slate-500">
                            <p><strong>How to play:</strong> Click a marble to select it (turns yellow), then click an empty hole to jump over the marble between them.</p>
                            <p class="mt-2">Goal: Leave only one marble in the center. Green holes show possible moves.</p>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-xl ring-1 ring-slate-200 p-6 sticky top-8">
                        <h2 class="text-xl font-bold text-slate-900 mb-4">Game Stats</h2>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="rounded-xl bg-amber-50 ring-1 ring-amber-100 p-4">
                                <div class="text-xs font-semibold uppercase tracking-wide text-amber-700">Marbles Left</div>
                                <div id="marbles-left" class="mt-1 text-3xl font-extrabold text-amber-900">32</div>
                            </div>
                            <div class="rounded-xl bg-blue-50 ring-1 ring-blue-100 p-4">
                                <div class="text-xs font-semibold uppercase tracking-wide text-blue-700">Moves Made</div>
                                <div id="moves-made" class="mt-1 text-3xl font-extrabold text-blue-900">0</div>
                            </div>
                            <div class="rounded-xl bg-green-50 ring-1 ring-green-100 p-4">
                                <div class="text-xs font-semibold uppercase tracking-wide text-green-700">Best Score</div>
                                <div id="best-score" class="mt-1 text-3xl font-extrabold text-green-900">1</div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">How to Play</h3>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>â€¢ Click a marble to select it (yellow)</li>
                                <li>â€¢ Green holes show where you can jump</li>
                                <li>â€¢ Jump over adjacent marbles to remove them</li>
                                <li>â€¢ Can only jump horizontally or vertically</li>
                                <li>â€¢ Goal: Leave only 1 marble in center</li>
                            </ul>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-sm font-bold text-slate-700 mb-2">Scoring</h3>
                            <ul class="text-sm text-slate-600 space-y-1">
                                <li>â€¢ Perfect: 1 marble left</li>
                                <li>â€¢ Good: 2-3 marbles left</li>
                                <li>â€¢ Fair: 4-6 marbles left</li>
                                <li>â€¢ Try again: 7+ marbles left</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Cross-shaped peg solitaire board layout
        const BOARD_LAYOUT = [
            [0, 0, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 0, 0],
            [1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1], // Center is valid hole
            [1, 1, 1, 1, 1, 1, 1],
            [0, 0, 1, 1, 1, 0, 0],
            [0, 0, 1, 1, 1, 0, 0]
        ];

        let board = [];
        let selectedMarble = null;
        let possibleMoves = [];
        let movesHistory = [];
        let movesCount = 0;

        const statusEl = document.getElementById('status');
        const substatusEl = document.getElementById('substatus');
        const boardEl = document.getElementById('board');
        const marblesLeftEl = document.getElementById('marbles-left');
        const movesMadeEl = document.getElementById('moves-made');
        const bestScoreEl = document.getElementById('best-score');

        const SCORES_KEY = 'solitaire:scores:v1';

        function initializeBoard() {
            board = BOARD_LAYOUT.map(row => [...row]);
            // Only center empty (traditional setup)
            board[3][3] = 0;
        }

        function createBoard() {
            boardEl.innerHTML = '';
            const holeSize = window.innerWidth >= 640 ? 48 : 40;
            const spacing = holeSize + 4; // 4px gap between holes

            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    if (BOARD_LAYOUT[row][col] === 0) continue; // Skip invalid positions

                    const hole = document.createElement('div');
                    hole.className = 'hole';
                    hole.dataset.row = row;
                    hole.dataset.col = col;

                    // Position the hole absolutely
                    hole.style.left = (col * spacing) + 'px';
                    hole.style.top = (row * spacing) + 'px';

                    if (board[row][col] === 1) {
                        const marble = document.createElement('div');
                        marble.className = 'marble';
                        hole.appendChild(marble);
                    } else {
                        hole.classList.add('empty');
                    }

                    hole.addEventListener('click', () => handleHoleClick(row, col));
                    boardEl.appendChild(hole);
                }
            }
            updateStats();
        }

        function handleHoleClick(row, col) {
            if (selectedMarble) {
                // Try to move to this position
                if (isValidMove(selectedMarble.row, selectedMarble.col, row, col)) {
                    makeMove(selectedMarble.row, selectedMarble.col, row, col);
                } else {
                    // Invalid move - show feedback
                    statusEl.textContent = 'Invalid move';
                    statusEl.className = 'mt-1 text-2xl font-bold text-red-600';
                    substatusEl.textContent = 'Try a different empty hole.';
                    setTimeout(() => {
                        statusEl.textContent = 'Marble selected';
                        statusEl.className = 'mt-1 text-2xl font-bold text-amber-600';
                        substatusEl.textContent = 'Click an empty hole to jump.';
                    }, 1500);
                }
                // Don't clear selection on invalid move
                if (!isValidMove(selectedMarble.row, selectedMarble.col, row, col)) {
                    return;
                }
                clearSelection();
            } else {
                // Select a marble
                if (board[row][col] === 1) {
                    selectMarble(row, col);
                }
            }
        }

        function selectMarble(row, col) {
            clearSelection();
            selectedMarble = { row, col };
            showPossibleMoves(row, col);

            const hole = getHoleElement(row, col);
            hole.classList.add('selected');

            statusEl.textContent = 'Marble selected';
            statusEl.className = 'mt-1 text-2xl font-bold text-amber-600';
            substatusEl.textContent = 'Click an empty hole to jump.';
        }

        function showPossibleMoves(row, col) {
            possibleMoves = getPossibleMoves(row, col);
            possibleMoves.forEach(([r, c]) => {
                const hole = getHoleElement(r, c);
                hole.classList.add('possible-move');
            });
        }

        function getPossibleMoves(row, col) {
            const moves = [];
            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1] // up, down, left, right
            ];

            directions.forEach(([dr, dc]) => {
                const jumpRow = row + dr;
                const jumpCol = col + dc;
                const landRow = row + 2 * dr;
                const landCol = col + 2 * dc;

                // Check bounds for all positions
                if (jumpRow >= 0 && jumpRow < 7 && jumpCol >= 0 && jumpCol < 7 &&
                    landRow >= 0 && landRow < 7 && landCol >= 0 && landCol < 7 &&
                    BOARD_LAYOUT[landRow][landCol] === 1 &&
                    board[jumpRow][jumpCol] === 1 && // marble to jump over
                    board[landRow][landCol] === 0) { // empty landing spot
                    moves.push([landRow, landCol]);
                }
            });

            return moves;
        }

        function isValidMove(fromRow, fromCol, toRow, toCol) {
            return possibleMoves.some(([r, c]) => r === toRow && c === toCol);
        }

        function makeMove(fromRow, fromCol, toRow, toCol) {
            // Calculate jumped position
            const jumpRow = (fromRow + toRow) / 2;
            const jumpCol = (fromCol + toCol) / 2;

            // Save state for undo
            movesHistory.push({
                board: board.map(row => [...row]),
                fromRow, fromCol, toRow, toCol, jumpRow, jumpCol
            });

            // Make the move
            board[fromRow][fromCol] = 0; // remove moving marble
            board[jumpRow][jumpCol] = 0; // remove jumped marble
            board[toRow][toCol] = 1; // place marble in new position

            movesCount++;
            createBoard();
            checkGameEnd();
        }

        function clearSelection() {
            if (selectedMarble) {
                const hole = getHoleElement(selectedMarble.row, selectedMarble.col);
                hole.classList.remove('selected');
            }
            selectedMarble = null;

            // Clear possible moves
            possibleMoves.forEach(([r, c]) => {
                const hole = getHoleElement(r, c);
                hole.classList.remove('possible-move');
            });
            possibleMoves = [];
        }

        function getHoleElement(row, col) {
            return boardEl.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        }

        function updateStats() {
            const marblesLeft = board.flat().reduce((sum, cell) => sum + cell, 0);
            marblesLeftEl.textContent = marblesLeft;
            movesMadeEl.textContent = movesCount;

            // Update best score
            const bestScore = Math.min(parseInt(localStorage.getItem(SCORES_KEY) || 32), marblesLeft);
            localStorage.setItem(SCORES_KEY, bestScore);
            bestScoreEl.textContent = bestScore;
        }

        function checkGameEnd() {
            const marblesLeft = board.flat().reduce((sum, cell) => sum + cell, 0);

            if (marblesLeft === 1) {
                statusEl.textContent = 'Perfect! ðŸŽ‰';
                statusEl.className = 'mt-1 text-2xl font-bold text-green-600';
                substatusEl.textContent = 'You left only one marble!';
            } else {
                // Check if any moves are possible
                let hasMoves = false;
                for (let row = 0; row < 7 && !hasMoves; row++) {
                    for (let col = 0; col < 7 && !hasMoves; col++) {
                        if (BOARD_LAYOUT[row][col] === 1 && board[row][col] === 1 && getPossibleMoves(row, col).length > 0) {
                            hasMoves = true;
                        }
                    }
                }

                if (!hasMoves) {
                    const message = marblesLeft <= 3 ? 'Excellent!' : marblesLeft <= 6 ? 'Well done!' : 'Good try!';
                    statusEl.textContent = `Game Over - ${message}`;
                    statusEl.className = 'mt-1 text-2xl font-bold text-blue-600';
                    substatusEl.textContent = `${marblesLeft} marbles left.`;
                } else {
                    statusEl.textContent = 'Keep playing';
                    statusEl.className = 'mt-1 text-2xl font-bold text-slate-900';
                    substatusEl.textContent = 'Select a marble to move.';
                }
            }
        }

        function newGame() {
            initializeBoard();
            selectedMarble = null;
            possibleMoves = [];
            movesHistory = [];
            movesCount = 0;
            statusEl.textContent = 'Select a marble to move';
            statusEl.className = 'mt-1 text-2xl font-bold text-slate-900';
            substatusEl.textContent = 'Click a marble, then click where to jump.';
            createBoard();
        }

        function undo() {
            if (movesHistory.length > 0) {
                const lastMove = movesHistory.pop();
                board = lastMove.board;
                movesCount--;
                createBoard();
                statusEl.textContent = 'Move undone';
                statusEl.className = 'mt-1 text-2xl font-bold text-slate-900';
                substatusEl.textContent = 'Select a marble to move.';
            }
        }

        // Event listeners
        document.getElementById('new-game').addEventListener('click', newGame);
        document.getElementById('undo').addEventListener('click', undo);

        // Initialize
        initializeBoard();
        createBoard();
    </script>
{% endblock %}